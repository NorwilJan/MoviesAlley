<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieHouse</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- your CSS, unchanged for brevity --- */
    /* Paste your CSS here if you want custom tweaks */
    :root {
      --primary-color: #3b82f6;
      --background-dark: #0f1216;
      --surface-dark: #1a1e24;
      --text-primary: #ffffff;
      --text-secondary: #d1d5db;
      --accent-color: #ff3870;
      --border-radius: 8px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    body { background: var(--background-dark); color: var(--text-primary); font-family: 'Inter', sans-serif; }
    /* ...keep all your previous CSS... */
    /* Keep grid, modal, navbar, movie card, spinner, etc. styles as you had */
  </style>
</head>
<body>
  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content" id="modal-content-movie">
      <span class="close" onclick="closeModal()">×</span>
      <div class="modal-body">
        <img id="modal-image" src="" alt="Poster">
        <div class="modal-text">
          <h2 id="modal-title"></h2>
          <div class="stars" id="modal-rating"></div>
          <div class="modal-genre" id="modal-genres"></div>
          <p id="modal-description"></p>
          <div class="modal-cast" id="modal-cast"></div>
          <div class="modal-crew" id="modal-crew"></div>
          <div class="modal-trailer" id="modal-trailer"></div>
          <button class="share-btn" id="share-movie-btn" onclick="shareMovie()">Share</button>
        </div>
      </div>
      <div class="server-selector">
        <label for="server">Change Server:</label>
        <select id="server" onchange="changeServer()">
          <option value="player.videasy.net" selected>Player.Videasy.net</option>
          <option value="vidsrc.cc">Vidsrc.cc</option>
          <option value="vidsrc.me">Vidsrc.me</option>
        </select>
      </div>
      <div class="iframe-container">
        <iframe id="modal-video" allowfullscreen autoplay></iframe>
        <button class="iframe-play-overlay" onclick="triggerIframePlay('modal-video')">
          <i class="fas fa-play"></i>
        </button>
      </div>
      <div id="similar-movies" style="padding: 1rem 2rem;"></div>
    </div>
    <div class="modal-content" id="modal-content-tv" style="display: none;">
      <span class="close" onclick="closeModal()">×</span>
      <div class="modal-body">
        <img id="tv-modal-image" src="" alt="Poster">
        <div class="modal-text">
          <h2 id="tv-modal-title"></h2>
          <div class="modal-genre" id="tv-modal-genres"></div>
          <p id="tv-modal-description"></p>
          <div><strong>First Air Date:</strong> <span id="tv-modal-air-date"></span></div>
          <div><strong>Seasons:</strong> <span id="tv-modal-total-seasons"></span></div>
          <button class="share-btn" id="share-tv-btn" onclick="shareTvShow()">Share</button>
          <button class="favorite-btn" id="tv-favorite-btn" title="Add to favorites" aria-label="Add to favorites" tabindex="0">
            <i class="fas fa-heart"></i>
          </button>
          <div id="tv-modal-seasons-list"></div>
        </div>
      </div>
      <div class="iframe-container">
        <iframe id="tv-episode-player" allowfullscreen autoplay style="display: none;"></iframe>
        <button class="iframe-play-overlay" onclick="triggerIframePlay('tv-episode-player')">
          <i class="fas fa-play"></i>
        </button>
      </div>
      <div style="display: flex; justify-content: center;">
        <button class="tv-episode-next-btn" id="tv-episode-next-btn" style="display: none; margin-bottom: 1em;">Next Episode »</button>
      </div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <span class="logo-text">MovieDck</span>
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto mb-2 mb-lg-0" id="movie-nav">
          <li class="nav-item"><a class="nav-link nav-link-1 active" id="nav-movies" href="#">Trending Movies</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-tvshows" href="#">Trending TV Shows</a></li>
          <li class="nav-item"><a class="nav-link nav-link-2" id="nav-anime" href="#">Trending Anime Movies</a></li>
          <li class="nav-item"><a class="nav-link nav-link-3" id="nav-tagalog" href="#">Trending Tagalog Movies</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-netflix" href="#"><i class="fab fa-netflix"></i> Trending Netflix</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-favorites" href="#"><i class="fas fa-heart"></i> Favorites</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- SEARCH BAR (with type picker) -->
  <div class="tm-hero d-flex justify-content-center align-items-center">
    <form class="tm-search-form" id="movie-search-form" autocomplete="off">
      <input class="tm-search-input" type="search" id="movie-search-input" placeholder="Search movies or TV shows..." aria-label="Search movies or TV shows">
      <select id="search-type" style="margin-left:5px;">
        <option value="all">All</option>
        <option value="movie">Movies</option>
        <option value="tv">TV Shows</option>
      </select>
      <button class="tm-search-btn" type="submit">
        <i class="fas fa-search"></i>
      </button>
    </form>
  </div>

  <div class="container-fluid tm-container-content tm-mt-60">
    <div id="recently-viewed-section" style="display: none;">
      <h5 style="color: var(--text-primary); margin-bottom: 0.7em;">Recently Viewed</h5>
      <div id="recently-viewed-list"></div>
    </div>
    <div class="row mb-4">
      <h2 class="col-6 tm-text-primary" id="section-title">Trending Movies</h2>
      <div class="col-6 d-flex justify-content-end align-items-center"></div>
    </div>
    <div class="row mb-4">
      <form class="genre-filter-form" id="genre-filter-form">
        <select id="genre-filter" aria-label="Filter movies by genre" role="listbox" disabled>
          <option value="" id="genre-all">Loading genres...</option>
        </select>
        <select id="year-filter" aria-label="Filter movies by year" role="listbox">
          <option value="" id="year-all">All Years</option>
        </select>
        <button type="button" id="clear-genre-btn" class="btn btn-outline-primary">Clear</button>
      </form>
    </div>
    <div class="row tm-mb-90 flex-wrap" id="movie-list" style="margin-left: 0; margin-right: 0;"></div>
    <div id="infinite-loader" style="display: none;"><div class="spinner"></div><p class="loading-state">Loading more...</p></div>
  </div>

  <button id="back-to-top" title="Back to Top" aria-label="Back to Top">
    <i class="fas fa-arrow-up"></i>
  </button>
  <button id="bmc-hover-btn" title="Support us on Buy Me a Coffee" aria-label="Support us on Buy Me a Coffee">
    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me a Coffee" class="bmc-button">
  </button>

  <footer class="tm-bg-gray pt-5 pb-3 tm-text-gray tm-footer">
    <div class="container-fluid tm-container-small">
      <div class="row">
        <div class="col-lg-6 col-md-12 col-12 px-5 mb-5">
          <h3 class="tm-text-primary mb-4 tm-footer-title">About MovieDck</h3>
          <p>MovieDck is a free, open movie & TV show browser using TMDB, supporting favorites and more. Built for education and fun.</p>
        </div>
        <div class="col-lg-3 col-md-6 col-sm-6 col-12 px-5 mb-5">
          <h3 class="tm-text-primary mb-4 tm-footer-title">Quick Links</h3>
          <ul class="tm-footer-links pl-0">
            <li><a href="mailto:norwilaxie@gmail.com">Contact</a></li>
            <li>
              <a href="https://www.buymeacoffee.com/MovieDckWFPH" target="_blank" rel="noopener" aria-label="Support us on Buy Me a Coffee">
                <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me a Coffee" class="bmc-button">
              </a>
            </li>
          </ul>
        </div>
        <div class="col-lg-3 col-md-6 col-sm-6 col-12 px-5 mb-5"></div>
      </div>
      <div class="row">
        <div class="col-lg-8 col-md-7 col-12 px-5 mb-3">Copyright 2025 MovieDck Project.</div>
      </div>
    </div>
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
  <script>
    // --- CONFIG ---
    const apiKey = '40f1982842db35042e8561b13b38d492';
    const imageBaseUrl = 'https://image.tmdb.org/t/p/w500';
    const maxPages = 100;
    const maxItems = 500;
    let lastModalMovie = null;
    let currentPage = 1;
    let totalPages = 1;
    let currentMode = "popular";
    let currentQuery = "";
    let currentGenre = "";
    let currentYear = "";
    let favorites = JSON.parse(localStorage.getItem('favorites') || "[]");
    let netflixType = "movie";
    let tvModalData = { tvId: null, season: null, episode: null, seasons: [] };
    let categoryItems = [];
    let isLoading = false;
    let reachedEnd = false;
    let loadedPages = new Set();
    let movieGenres = [];
    let tvGenres = [];
    const animeGenres = [
      { id: 16, name: "Anime" },
      { id: 10765, name: "Sci-Fi & Fantasy" },
      { id: 28, name: "Action" },
      { id: 12, name: "Adventure" },
      { id: 35, name: "Comedy" },
      { id: 18, name: "Drama" },
      { id: 10749, name: "Romance" },
      { id: 14, name: "Fantasy" }
    ];
    const movieList = document.getElementById('movie-list');
    const infiniteLoader = document.getElementById('infinite-loader');
    const genreFilter = document.getElementById('genre-filter');

    // --- Throttle ---
    function throttle(func, limit) {
      let inThrottle;
      return function (...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => (inThrottle = false), limit);
        }
      };
    }

    // --- UNLIMITED SCROLL ---
    async function loadMoreMovies(clear = false) {
      if (isLoading || reachedEnd || currentPage > maxPages) return;
      isLoading = true;
      if (clear) {
        movieList.innerHTML = '<div class="loading-state">Loading...</div>';
        categoryItems = [];
      }
      infiniteLoader.style.display = "block";
      const items = await fetchMoviesInf(currentPage);
      if (items.length > 0) {
        // Remove duplicates by id
        const alreadyIds = new Set(categoryItems.map(i => i.id));
        const newItems = items.filter(i => !alreadyIds.has(i.id));
        categoryItems = [...categoryItems, ...newItems];
        renderMovies(newItems, clear);
        currentPage++;
        if (currentPage > totalPages) reachedEnd = true;
      } else {
        reachedEnd = true;
        if (clear && !categoryItems.length) {
          movieList.innerHTML = `<div class="empty-state">No items found.</div>`;
        }
      }
      isLoading = false;
      infiniteLoader.style.display = "none";
    }

    // --- RENDER MOVIES (batch DOM update) ---
    function renderMovies(items, clear = false) {
      if (clear) movieList.innerHTML = '';
      if (!items || items.length === 0) return;
      const fragment = document.createDocumentFragment();
      items.forEach(item => {
        const isTv = item.media_type === 'tv' || (!!item.name && !item.title);
        const mediaType = isTv ? 'tv' : 'movie';
        const movieDiv = document.createElement('div');
        movieDiv.className = 'movie-col';
        movieDiv.innerHTML = `
          <div class="movie-poster-wrapper" tabindex="0">
            <img src="${item.poster_path ? imageBaseUrl + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="img-fluid movie-poster-img">
            <button class="play-btn-centered" type="button" title="${isTv ? "View TV Show" : "Play Movie"}">
              <i class="fas fa-${isTv ? "tv" : "play"}"></i>
            </button>
            <button class="favorite-btn${isFavorite(item.id, mediaType) ? ' favorited' : ''}" title="Add to favorites" aria-label="Add to favorites" tabindex="0">
              <i class="fas fa-heart"></i>
            </button>
          </div>
          <div class="movie-metadata">
            <span class="movie-title" title="${isTv ? item.name : item.title}">${isTv ? item.name : item.title}</span>
            <span class="movie-year">${(isTv ? item.first_air_date : item.release_date) ? (isTv ? item.first_air_date : item.release_date).slice(0, 4) : ""}</span>
            ${isTv ? '<span class="movie-type" style="font-size: 0.9em; color: var(--primary-color);">TV Show</span>' : ''}
          </div>
        `;
        movieDiv.querySelector('.play-btn-centered').onclick = () => { isTv ? showTvDetails(item) : showDetails(item); };
        movieDiv.querySelector('.favorite-btn').onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(item.id, mediaType);
        };
        fragment.appendChild(movieDiv);
      });
      requestAnimationFrame(() => {
        movieList.appendChild(fragment);
      });
    }

    // --- SCROLL HANDLER ---
    const handleScroll = throttle(() => {
      if (currentMode === 'favorites') return;
      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      if (scrollTop + clientHeight >= scrollHeight - 300 && !isLoading && !reachedEnd) {
        loadMoreMovies();
      }
    }, 100);
    window.addEventListener('scroll', handleScroll);

    // --- SEARCH BAR, with type picker and filtering ---
    let searchTimeout;
    function handleSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = document.getElementById('movie-search-input').value.trim();
        const type = document.getElementById('search-type').value;
        if (!query) return;

        currentQuery = query;
        currentMode = 'search';
        resetInfiniteScroll();

        fetchMoviesInf(currentPage).then(results => {
          let filtered;
          if (type === "all") {
            filtered = results.filter(item => item.media_type === "movie" || item.media_type === "tv");
          } else {
            filtered = results.filter(item => item.media_type === type);
          }
          renderMovies(filtered, true);
        });
      }, 300);
    }

    document.addEventListener("DOMContentLoaded", function () {
      // ...rest of your DOMContentLoaded code for nav, modal, filters, etc...
      document.getElementById('movie-search-form').onsubmit = function (e) {
        e.preventDefault();
        handleSearch();
      };
      document.getElementById('movie-search-input').oninput = handleSearch;
      document.getElementById('search-type').onchange = handleSearch;
      // ...rest: navbar, genre filter, etc...
    });

    // --- Replace the rest of your JS code here with the improved versions above ---
    // (Favorites, modal, filters, TV details, etc. unchanged from your previous code)

    // --- Fetch and render logic ---
    async function fetchMoviesInf(page = 1) {
      if (loadedPages.has(page) || page > maxPages) return [];
      let url = "";
      if (currentMode === "favorites") return [];
      if (currentMode === "search" && currentQuery.trim()) {
        url = `https://api.themoviedb.org/3/search/multi?api_key=${apiKey}&query=${encodeURIComponent(currentQuery)}&page=${page}&include_adult=false`;
      } else if (currentMode === "anime") {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_genres=${currentGenre || 16}&with_original_language=ja${currentYear ? `&primary_release_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === "tagalog") {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_original_language=tl${currentGenre ? `&with_genres=${currentGenre}` : ''}${currentYear ? `&primary_release_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === "tv") {
        url = `https://api.themoviedb.org/3/discover/tv?api_key=${apiKey}${currentGenre ? `&with_genres=${currentGenre}` : ''}${currentYear ? `&first_air_date_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === "netflix") {
        if (netflixType === "movie") {
          url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_watch_providers=8&watch_region=US${currentGenre ? `&with_genres=${currentGenre}` : ''}${currentYear ? `&primary_release_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
        } else {
          url = `https://api.themoviedb.org/3/discover/tv?api_key=${apiKey}&with_watch_providers=8&watch_region=US${currentGenre ? `&with_genres=${currentGenre}` : ''}${currentYear ? `&first_air_date_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
        }
      } else {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}${currentGenre ? `&with_genres=${currentGenre}` : ''}${currentYear ? `&primary_release_year=${currentYear}` : ''}&sort_by=popularity.desc&page=${page}`;
      }
      try {
        genreFilter.disabled = true;
        document.getElementById('year-filter').disabled = true;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        totalPages = Math.min(data.total_pages || 1, maxPages);
        loadedPages.add(page);
        return data.results || [];
      } catch (e) {
        movieList.innerHTML = `<div class="error-state">Failed to load content.</div>`;
        infiniteLoader.style.display = "none";
        return [];
      } finally {
        genreFilter.disabled = false;
        document.getElementById('year-filter').disabled = false;
      }
    }

    function resetInfiniteScroll() {
      currentPage = 1;
      totalPages = 1;
      loadedPages.clear();
      reachedEnd = false;
      categoryItems = [];
      isLoading = false;
      movieList.innerHTML = '<div class="loading-state">Loading...</div>';
      infiniteLoader.style.display = 'block';
      loadMoreMovies(true);
    }

    // --- Keep your favorites, modal, TV, filters code as before ---
    // ... (for brevity, not pasted here, you can keep your implementations)

  </script>
</body>
</html>